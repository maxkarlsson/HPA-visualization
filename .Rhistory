mutate(sub_cluster = select(., V1, V2) %>%
as.data.frame() %>%
fpc::dbscan(eps = 0.2) %$%
cluster)
# plot_data_sub <-
plot_data %>%
# group_by(cluster) %>%
filter(cluster == 20) %>%
mutate(sub_cluster = select(., V1, V2) %>%
as.data.frame() %>%
fpc::dbscan(eps = 0.2) %$%
cluster)
# plot_data_sub <-
plot_data %>%
filter(cluster == 20) %>%
group_by(cluster) %>%
mutate(sub_cluster = select(., V1, V2) %>%
as.data.frame() %>%
fpc::dbscan(eps = 0.2) %$%
cluster)
# plot_data_sub <-
plot_data %>%
filter(cluster == 20) %>%
group_by(cluster) %>%
mutate(sub_cluster = select(V1, V2) %>%
as.data.frame() %>%
fpc::dbscan(eps = 0.2) %$%
cluster)
# plot_data_sub <-
plot_data %>%
filter(cluster == 20) %>%
group_by(cluster) %>%
mutate(sub_cluster = (V1, V2) %>%
fpc::dbscan(eps = 0.2) %$%
cluster)
# plot_data_sub <-
plot_data %>%
filter(cluster == 20) %>%
group_by(cluster) %>%
mutate(sub_cluster = data.frame(V1, V2) %>%
fpc::dbscan(eps = 0.2) %$%
cluster)
# plot_data_sub <-
plot_data %>%
group_by(cluster) %>%
mutate(sub_cluster = data.frame(V1, V2) %>%
fpc::dbscan(eps = 0.2) %$%
cluster)
plot_data_sub <-
plot_data %>%
group_by(cluster) %>%
mutate(sub_cluster = data.frame(V1, V2) %>%
fpc::dbscan(eps = 0.2) %$%
cluster)
plot_data_sub
plot_data_sub <-
plot_data %>%
group_by(cluster) %>%
mutate(sub_cluster = data.frame(V1, V2) %>%
fpc::dbscan(eps = 0.2) %$%
cluster) %>%
ungroup()
plot_data_sub %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point()
library(patchwork)
plot_data_sub %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
facet_wrap(~ cluster) +
theme_bw()
plot_data_sub %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw()
plot_data_sub
plot_data_sub %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
plot_data_sub %>%
filter(sub_cluster != 0) %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw()
plot_data_sub
plot_data_sub %>%
filter(sub_cluster != 0) %>%
group_by(cluster, sub_cluster) %>%
count()
plot_data_sub %>%
filter(sub_cluster != 0) %>%
group_by(cluster, sub_cluster) %>%
count() %>%
spread(sub_cluster, n)
plot_data_sub %>%
filter(sub_cluster != 0) %>%
group_by(cluster, sub_cluster) %>%
count() %>%
spread(sub_cluster, n, fill = 0) %>%
column_to_rownames("cluster")
plot_data_sub %>%
filter(sub_cluster != 0) %>%
group_by(cluster, sub_cluster) %>%
count() %>%
spread(sub_cluster, n, fill = 0) %>%
column_to_rownames("cluster") %>%
pheatmap()
library(pheatmap)
plot_data_sub %>%
filter(sub_cluster != 0) %>%
group_by(cluster, sub_cluster) %>%
count() %>%
spread(sub_cluster, n, fill = 0) %>%
column_to_rownames("cluster") %>%
pheatmap()
plot_data_sub %>%
filter(sub_cluster != 0) %>%
group_by(cluster, sub_cluster) %>%
count() %>%
spread(sub_cluster, n, fill = 0)
plot_data_sub %>%
filter(sub_cluster != 0) %>%
group_by(cluster)
plot_data_sub %>%
filter(sub_cluster != 0) %>%
group_by(cluster, sub_cluster) %>%
count()
keep_subclusters <-
plot_data_sub %>%
filter(sub_cluster != 0) %>%
group_by(cluster, sub_cluster) %>%
count() %>%
group_by(cluster) %>%
top_n(sub_cluster, 1)
warnings()
keep_subclusters
plot_data_sub %>%
filter(sub_cluster != 0) %>%
group_by(cluster, sub_cluster) %>%
count() %>%
group_by(cluster)
keep_subclusters <-
plot_data_sub %>%
filter(sub_cluster != 0) %>%
group_by(cluster, sub_cluster) %>%
count() %>%
group_by(cluster) %>%
top_n(1, sub_cluster)
keep_subclusters
keep_subclusters <-
plot_data_sub %>%
filter(sub_cluster != 0) %>%
group_by(cluster, sub_cluster) %>%
count() %>%
group_by(cluster) %>%
top_n(1, sub_cluster) %>%
slice(1)
keep_subclusters
keep_subclusters <-
plot_data_sub %>%
filter(sub_cluster != 0) %>%
group_by(cluster, sub_cluster) %>%
count() %>%
group_by(cluster) %>%
top_n(1, sub_cluster) %>%
slice(1) %>%
ungroup()
plot_data_sub %>%
filter(sub_cluster != 0) %>%
group_by(cluster, sub_cluster) %>%
count()
keep_subclusters <-
plot_data_sub %>%
filter(sub_cluster != 0) %>%
group_by(cluster, sub_cluster) %>%
count() %>%
group_by(cluster) %>%
top_n(1, n) %>%
slice(1) %>%
ungroup()
keep_subclusters
plot_data_sub %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
plot_data_sub %>%
filter(sub_cluster != 0) %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
plot_data_sub %>%
inner_join(keep_subclusters) %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw()
plot_data_sub %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
ggtitle("All points") +
plot_data_sub %>%
filter(sub_cluster != 0) %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
ggtitle("No outliers") +
plot_data_sub %>%
inner_join(keep_subclusters) %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
ggtitle("Only main cluster")
subcluster_count <-
plot_data_sub %>%
filter(sub_cluster != 0) %>%
group_by(cluster, sub_cluster) %>%
count() %>%
group_by(cluster) %>%
mutate(frac = n / sum(n))
subcluster_count
subcluster_count %>%
filter(frac > 0.1)
subcluster_count <-
plot_data_sub %>%
group_by(cluster, sub_cluster) %>%
count() %>%
group_by(cluster) %>%
mutate(frac = n / sum(n))
subcluster_count %>%
filter(frac > 0.1)
subcluster_count %>%
filter(frac > 0.1) %>%
filter(sub_cluster != 0)
keep_subcluster_fraction <-
subcluster_count %>%
filter(frac > 0.1) %>%
filter(sub_cluster != 0)
keep_subclusters <-
subcluster_count %>%
top_n(1, n) %>%
slice(1) %>%
ungroup()
plot_data_sub %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
ggtitle("All points") +
plot_data_sub %>%
filter(sub_cluster != 0) %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
ggtitle("No outliers") +
plot_data_sub %>%
inner_join(keep_subcluster_fraction) %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
ggtitle("Only subcluster of 10% total") +
plot_data_sub %>%
inner_join(keep_subclusters) %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
ggtitle("Only main cluster")
keep_subcluster_fraction <-
subcluster_count %>%
filter(frac > 0.05) %>%
filter(sub_cluster != 0)
keep_subcluster_fraction
plot_data_sub %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
ggtitle("All points") +
plot_data_sub %>%
filter(sub_cluster != 0) %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
ggtitle("No outliers") +
plot_data_sub %>%
inner_join(keep_subcluster_fraction) %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
ggtitle("Only subcluster of 5% total") +
plot_data_sub %>%
inner_join(keep_subclusters) %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
ggtitle("Only main cluster")
ggsave("results/UMAP/subcluster removal.pdf", width = 8, height = 8)
plot_data_sub
plot_data_sub %>%
inner_join(keep_subcluster_fraction)
plot_data_sub_frac <-
plot_data_sub %>%
inner_join(keep_subcluster_fraction) %>%
plot_density_all <-
plot_settings %>%
select(h, n) %>%
distinct() %>%
group_by_all() %>%
do({
h <- .$h
n <- .$n
plot_data %>%
group_by(cluster) %>%
do({
get_density(.$V1,
.$V2,
h = h,
n = n,
lims = plot_range)
})
}) %>%
ungroup() %>%
left_join(plot_settings) %>%
group_by(h, n, z_lim, cluster) %>%
mutate(z_rel = z / max(z)) %>%
ungroup() %>%
filter(z_rel > z_lim)
plot_data_sub_frac <-
plot_data_sub %>%
inner_join(keep_subcluster_fraction)
plot_density_frac_all <-
plot_settings %>%
select(h, n) %>%
distinct() %>%
group_by_all() %>%
do({
h <- .$h
n <- .$n
plot_data_sub_frac %>%
group_by(cluster) %>%
do({
get_density(.$V1,
.$V2,
h = h,
n = n,
lims = plot_range)
})
}) %>%
ungroup() %>%
left_join(plot_settings) %>%
group_by(h, n, z_lim, cluster) %>%
mutate(z_rel = z / max(z)) %>%
ungroup() %>%
filter(z_rel > z_lim)
p <-
plot_density_frac_all %>%
group_by(h, n, z_lim, x, y) %>%
top_n(1, z) %>%
slice(1) %>%
ggplot(aes(x_coord, y_coord, fill = cluster))+
geom_tile(show.legend = F) +
scale_fill_manual(values = plot_palette) +
coord_fixed() +
facet_grid(h ~ z_lim) +
theme_bw()
ggsave("results/UMAP/UMAP density settings cluster frac.pdf", plot = p, width = 8, height = 6)
plot_density_frac_all
plot_density_frac_all %>%
filter(h == 0.2 & z_lim == 0.001)
plot_density_frac_all %>%
filter(h == 0.2 & z_lim == 0.001) %>%
group_by(h, n, z_lim, x, y) %>%
top_n(1, z) %>%
slice(1)
plot_density_frac_all %>%
filter(h == 0.2 & z_lim == 0.001) %>%
group_by(h, n, z_lim, x, y) %>%
top_n(1, z) %>%
slice(1) %>%
ggplot(aes(x_coord, y_coord, fill = cluster))+
geom_tile(show.legend = F) +
scale_fill_manual(values = plot_palette) +
coord_fixed() +
facet_wrap(~ cluster) +
theme_bw()
ggsave("results/UMAP/UMAP density cluster frac.pdf", width = 10, height = 10)
keep_subcluster_fraction <-
subcluster_count %>%
filter(frac > 0.1) %>%
filter(sub_cluster != 0)
keep_subclusters <-
subcluster_count %>%
top_n(1, n) %>%
slice(1) %>%
ungroup()
plot_data_sub %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
ggtitle("All points") +
plot_data_sub %>%
filter(sub_cluster != 0) %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
ggtitle("No outliers") +
plot_data_sub %>%
inner_join(keep_subcluster_fraction) %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
ggtitle("Only subcluster of 10% total") +
plot_data_sub %>%
inner_join(keep_subclusters) %>%
ggplot(aes(V1, V2, color = factor(cluster))) +
geom_point(show.legend = F) +
scale_color_manual(values = plot_palette) +
coord_fixed() +
theme_bw() +
ggtitle("Only main cluster")
ggsave("results/UMAP/subcluster removal.pdf", width = 8, height = 8)
plot_data_sub_frac <-
plot_data_sub %>%
inner_join(keep_subcluster_fraction)
plot_density_frac_all <-
plot_settings %>%
select(h, n) %>%
distinct() %>%
group_by_all() %>%
do({
h <- .$h
n <- .$n
plot_data_sub_frac %>%
group_by(cluster) %>%
do({
get_density(.$V1,
.$V2,
h = h,
n = n,
lims = plot_range)
})
}) %>%
ungroup() %>%
left_join(plot_settings) %>%
group_by(h, n, z_lim, cluster) %>%
mutate(z_rel = z / max(z)) %>%
ungroup() %>%
filter(z_rel > z_lim)
p <-
plot_density_frac_all %>%
group_by(h, n, z_lim, x, y) %>%
top_n(1, z) %>%
slice(1) %>%
ggplot(aes(x_coord, y_coord, fill = cluster))+
geom_tile(show.legend = F) +
scale_fill_manual(values = plot_palette) +
coord_fixed() +
facet_grid(h ~ z_lim) +
theme_bw()
ggsave("results/UMAP/UMAP density settings cluster frac.pdf", plot = p, width = 8, height = 6)
plot_density_frac_all %>%
filter(h == 0.2 & z_lim == 0.001) %>%
group_by(h, n, z_lim, x, y) %>%
top_n(1, z) %>%
slice(1) %>%
ggplot(aes(x_coord, y_coord, fill = cluster))+
geom_tile(show.legend = F) +
scale_fill_manual(values = plot_palette) +
coord_fixed() +
facet_wrap(~ cluster) +
theme_bw()
ggsave("results/UMAP/UMAP density cluster frac.pdf", width = 10, height = 10)
